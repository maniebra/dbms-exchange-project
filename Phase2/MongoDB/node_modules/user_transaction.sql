
WITH user2_wallet AS (
    SELECT wallet_id
    FROM wallets
    WHERE owner_id = 2 AND crypto_id = 3
),
user3_wallet AS (
    SELECT wallet_id
    FROM wallets
    WHERE owner_id = 3 AND crypto_id = 3
),

insert_order1 AS (
    INSERT INTO orders (is_sell, state, fill, client_id, date, market_id, amount)
    VALUES (FALSE, 'pending', 100, 2, NOW(), 1, 100)
    RETURNING order_id
),
insert_order2 AS (
    INSERT INTO orders (is_sell, state, fill, client_id, date, market_id, amount)
    VALUES (TRUE, 'pending', 100, 3, NOW(), 1, 100)
    RETURNING order_id
),
insert_p2p AS (
    INSERT INTO p2p (date_placed, fill, wage, value, min_fill_remainder, market_id, taker_order_id, maker_order_id)
    SELECT NOW(), 100, 1, 100, 10, 1, 
           (SELECT order_id FROM insert_order1), 
           (SELECT order_id FROM insert_order2)
    RETURNING taker_order_id, maker_order_id
)


UPDATE orders
SET state = 'end'
WHERE order_id IN ((SELECT order_id FROM insert_order1), (SELECT order_id FROM insert_order2));
